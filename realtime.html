<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Kiểm tra tem real-time</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 min-h-screen text-gray-800">
  <header class="bg-white shadow-sm mb-4">
    <div class="max-w-5xl mx-auto px-4 py-4 flex justify-between items-center">
      <h1 class="text-xl font-bold text-gray-900">
        Real-time Label Check
      </h1>
      <a href="/" class="text-blue-600 text-sm hover:underline">
        ← Quay lại trang upload ảnh
      </a>
    </div>
  </header>

  <main class="max-w-5xl mx-auto px-4">
    <div class="bg-white rounded-xl shadow p-4 mb-4">
      <h2 class="font-semibold mb-2">Camera iVCam</h2>
      <p class="text-sm text-gray-500 mb-2">
        Đảm bảo iVCam đang chạy và được chọn đúng camera index trong <code>main.py</code>.
      </p>
      <div class="bg-black rounded-lg overflow-hidden flex items-center justify-center h-80">
        <!-- MJPEG stream -->
        <img id="video-stream" src="/video_feed"
             class="w-full h-full object-contain" alt="Video stream">
      </div>
    </div>

    <div class="bg-white rounded-xl shadow p-4">
      <h2 class="font-semibold mb-2">Trạng thái tem</h2>
      <p id="rt-text" class="text-lg font-bold text-gray-800 mb-2">
        Đang chờ tín hiệu...
      </p>
      <ul class="text-sm text-gray-600 list-disc pl-5">
        <li><span class="font-semibold text-green-600">Tem dán ĐÚNG</span> → phát âm thanh đúng.</li>
        <li><span class="font-semibold text-red-600">Tem sai (lệch / rách / thiếu)</span> → phát âm thanh sai.</li>
      </ul>
    </div>
  </main>

  <!-- Âm thanh -->
  <audio id="sound-ok">
  <source src="dung.mp3" type="audio/mpeg">
</audio>
<audio id="sound-ng">
  <source src="sai.mp3" type="audio/mpeg">
</audio>


  <script>
    const rtText   = document.getElementById("rt-text");
    const soundOk  = document.getElementById("sound-ok");
    const soundNg  = document.getElementById("sound-ng");

    let lastStatus = null;
    let firstRun   = true;

    function mapStatusToText(st) {
      switch (st) {
        case "dan_dung":       return "Tem dán ĐÚNG ";
        case "dan_lech":       return "Tem dán LỆCH ";
        case "tem_rach":       return "TEM RÁCH / LỖ ";
        case "khong_tim_thay": return "Không tìm thấy tem ";
        default:               return "Không rõ trạng thái";
      }
    }

    function isStatusOk(st) {
      return st === "dan_dung";
    }

    function pollStatus() {
      fetch("/rt_status")
        .then(res => res.json())
        .then(data => {
          const st = data.status || "khong_tim_thay";

          rtText.textContent = mapStatusToText(st);

          if (!firstRun && st !== lastStatus) {
            // trạng thái thay đổi → phát âm thanh
            if (isStatusOk(st)) {
              soundOk.currentTime = 0;
              soundOk.play().catch(() => {});
            } else {
              soundNg.currentTime = 0;
              soundNg.play().catch(() => {});
            }
          }

          lastStatus = st;
          firstRun = false;
        })
        .catch(err => {
          console.error("Lỗi lấy rt_status:", err);
        })
        .finally(() => {
          setTimeout(pollStatus, 300); // 300ms / lần
        });
    }

    // bắt đầu polling
    pollStatus();
  </script>
</body>
</html>
