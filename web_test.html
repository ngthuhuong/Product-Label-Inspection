<!DOCTYPE html>
<html>
<head>
    <title>Kiểm Tra Tem Dán Tự Động</title>
    <style>
        /* CSS cơ bản */
        body { font-family: Arial, sans-serif; text-align: center; margin: 20px; background-color: #f4f4f4; color: #333; }
        h1 { color: #0056b3; }
        .tab-buttons { margin-bottom: 20px; }
        .tab-buttons button {
            margin: 0 5px; padding: 10px 20px; font-size: 16px; cursor: pointer;
            background-color: #e0e0e0; border: 1px solid #ccc; border-radius: 5px;
            transition: background-color 0.3s ease;
        }
        .tab-buttons button.active { background-color: #007bff; color: white; border-color: #007bff; }
        .tab-buttons button:hover:not(.active) { background-color: #d0d0d0; }

        .tab-content {
            border: 1px solid #ccc; padding: 20px; margin-top: 10px;
            background-color: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .hidden { display: none; }

        /* Điều chỉnh kích thước ảnh hiển thị */
        #video-output, #image-preview {
            max-width: 450px; /* Giới hạn chiều rộng tối đa */
            height: auto;     /* Giữ tỷ lệ khung hình */
            margin-top: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        #result-display {
            font-size: 2em; margin: 20px auto; padding: 10px 20px; font-weight: bold;
            border: 2px solid; display: inline-block; min-width: 300px; border-radius: 5px;
        }
        .pass { background-color: #d4edda; color: #155724; border-color: #c3e6cb; }
        .fail { background-color: #f8d7da; color: #721c24; border-color: #f5c6cb; }

        /* Style cho kéo thả */
        #drop-area {
            border: 2px dashed #007bff; padding: 50px; text-align: center;
            cursor: pointer; margin-top: 10px; border-radius: 8px;
            background-color: #eaf6ff; color: #0056b3;
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        #drop-area.highlight { border-color: #0056b3; background-color: #cceeff; }
        #drop-area p { margin: 0; font-size: 1.1em; }

        #image-controls { margin-top: 10px; }
        #image-controls button {
            padding: 8px 15px; margin: 5px; font-size: 1em; cursor: pointer;
            background-color: #007bff; color: white; border: none; border-radius: 5px;
        }
        #image-controls button:hover { background-color: #0056b3; }

    </style>
</head>
<body>
    <h1>Kiểm Tra Chất Lượng Tem Dán</h1>

    <div class="tab-buttons">
        <button id="btn-photo" onclick="showTab('photo')">Kiểm tra Ảnh</button>
        <button id="btn-video" onclick="showTab('video')">Kiểm tra Video</button>
    </div>

    <div id="result-display">... Chọn ảnh hoặc video để bắt đầu ...</div>

    <div id="photo-tab" class="tab-content">
        <h2>Kiểm tra Ảnh Tĩnh</h2>
        <form id="image-form">
            <input type="file" id="fileElem" accept="image/*" class="hidden">

            <div id="drop-area">
                <p>Kéo và thả ảnh vào đây</p>
                <p>hoặc nhấn để chọn ảnh</p>
            </div>

            <img id="image-preview" src="" alt="Ảnh xem trước" class="hidden">

            <div id="image-controls" class="hidden">
                <button type="submit" id="check-btn">Kiểm tra</button>
                <button type="button" id="reset-image-btn">Chọn lại ảnh</button>
            </div>
        </form>
    </div>

    <div id="video-tab" class="tab-content hidden">
        <h2>Kiểm tra Video (Dây chuyền)</h2>
        <form id="video-form">
            <input type="file" name="video" accept="video/*" required>
            <button type="submit">Bắt đầu Kiểm tra</button>
        </form>
        <img id="video-output" src="" alt="Video Processing Output">
    </div>

    <script>
        // --- LOGIC CHUYỂN TAB ---
        function showTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.tab-buttons button').forEach(btn => btn.classList.remove('active'));

            document.getElementById(tabId + '-tab').classList.remove('hidden');
            document.getElementById('btn-' + tabId).classList.add('active');

            // Reset hiển thị kết quả khi chuyển tab
            const resultDisplay = document.getElementById('result-display');
            resultDisplay.textContent = '... Chọn ảnh hoặc video để bắt đầu ...';
            resultDisplay.className = '';
        }
        showTab('photo'); // Mặc định hiển thị tab Ảnh

        // --- LOGIC KÉO VÀ THẢ ẢNH (Drag and Drop) ---
        const dropArea = document.getElementById('drop-area');
        const fileElem = document.getElementById('fileElem');
        const imagePreview = document.getElementById('image-preview');
        const imageControls = document.getElementById('image-controls'); // Điều khiển mới
        const resetImageBtn = document.getElementById('reset-image-btn'); // Nút mới

        // Mở hộp thoại chọn file khi nhấn vào vùng kéo thả
        dropArea.addEventListener('click', () => fileElem.click());

        // Xử lý sự kiện file được chọn (hoặc kéo thả)
        fileElem.addEventListener('change', handleFiles, false);
        dropArea.addEventListener('dragenter', highlight, false);
        dropArea.addEventListener('dragleave', unhighlight, false);
        dropArea.addEventListener('dragover', highlight, false);
        dropArea.addEventListener('drop', handleDrop, false);

        function highlight(e) {
            e.preventDefault();
            dropArea.classList.add('highlight');
        }
        function unhighlight(e) {
            e.preventDefault();
            dropArea.classList.remove('highlight');
        }

        function handleDrop(e) {
            unhighlight(e);
            let dt = e.dataTransfer;
            let files = dt.files;
            handleFiles({ target: { files: files } });
        }

        let currentImageFile = null;

        function handleFiles(e) {
            const files = e.target.files;
            if (files.length > 0) {
                currentImageFile = files[0];
                const reader = new FileReader();
                reader.onload = (event) => {
                    imagePreview.src = event.target.result;
                    imagePreview.classList.remove('hidden');
                    imageControls.classList.remove('hidden'); // Hiển thị nút điều khiển
                    dropArea.classList.add('hidden'); // Ẩn vùng kéo thả khi đã có ảnh

                    // Reset kết quả hiển thị
                    const resultDisplay = document.getElementById('result-display');
                    resultDisplay.textContent = '... Sẵn sàng kiểm tra ảnh ...';
                    resultDisplay.className = '';
                };
                reader.readAsDataURL(currentImageFile);
            }
        }

        // --- LOGIC NÚT "CHỌN LẠI ẢNH" ---
        resetImageBtn.addEventListener('click', function() {
            currentImageFile = null;
            fileElem.value = ''; // Xóa file đã chọn
            imagePreview.src = '';
            imagePreview.classList.add('hidden');
            imageControls.classList.add('hidden');
            dropArea.classList.remove('hidden'); // Hiển thị lại vùng kéo thả

            // Reset kết quả hiển thị
            const resultDisplay = document.getElementById('result-display');
            resultDisplay.textContent = '... Chọn ảnh hoặc video để bắt đầu ...';
            resultDisplay.className = '';
        });

        // --- LOGIC GỬI ẢNH (PHOTO) LÊN SERVER ---
        document.getElementById('image-form').addEventListener('submit', function(e) {
            e.preventDefault();

            if (!currentImageFile) {
                alert("Vui lòng chọn một ảnh để kiểm tra.");
                return;
            }

            const resultDisplay = document.getElementById('result-display');
            resultDisplay.textContent = 'Đang kiểm tra...';
            resultDisplay.className = '';

            const formData = new FormData();
            formData.append('image', currentImageFile);

            fetch('/process_image', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                // Cập nhật ảnh đã đánh dấu
                imagePreview.src = 'data:image/jpeg;base64,' + data.processed_image_base64;

                // Cập nhật kết quả Đạt/Lỗi
                resultDisplay.textContent = data.result;
                resultDisplay.className = data.result.includes('ĐẠT') ? 'pass' : 'fail';
            })
            .catch(error => {
                console.error('Lỗi kiểm tra ảnh:', error);
                resultDisplay.textContent = 'Lỗi xử lý ảnh.';
                resultDisplay.className = 'fail';
            });
        });

        // --- LOGIC XỬ LÝ VIDEO (Như cũ, chỉ điều chỉnh message ban đầu) ---
        document.getElementById('video-form').addEventListener('submit', function(e) {
            e.preventDefault();

            const form = e.target;
            const formData = new FormData(form);
            const resultDisplay = document.getElementById('result-display');
            const videoOutput = document.getElementById('video-output');

            resultDisplay.textContent = 'Đang xử lý video...';
            resultDisplay.className = '';

            fetch('/upload_and_process', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (response.body) {
                    const reader = response.body.getReader();
                    const decoder = new TextDecoder();
                    let buffer = '';

                    function processStream({done, value}) {
                        if (done) {
                            resultDisplay.textContent = 'Kiểm tra video hoàn tất.';
                            return;
                        }

                        buffer += decoder.decode(value, {stream: true});
                        const parts = buffer.split('\n\n');
                        buffer = parts.pop();

                        parts.forEach(part => {
                            if (part.startsWith('data: ')) {
                                const data = part.substring(6);
                                const [frame_base64, result] = data.split('|');

                                videoOutput.src = 'data:image/jpeg;base64,' + frame_base64;
                                resultDisplay.textContent = result;
                                if (result.includes('ĐẠT')) {
                                    resultDisplay.className = 'pass';
                                } else if (result.includes('LỖI')) {
                                    resultDisplay.className = 'fail';
                                } else {
                                    resultDisplay.className = '';
                                }
                            }
                        });

                        return reader.read().then(processStream);
                    }

                    return reader.read().then(processStream);
                }
            })
            .catch(error => {
                console.error('Lỗi khi xử lý video:', error);
                resultDisplay.textContent = 'Lỗi kết nối hoặc xử lý video.';
                resultDisplay.className = 'fail';
            });
        });

    </script>
</body>
</html>